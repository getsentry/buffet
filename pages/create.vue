<script setup lang="ts">
// https://vueuse.org/core/useStorage/#usage
import { Field, Form, ErrorMessage } from "vee-validate";
import { z } from "zod";
import { toTypedSchema } from "@vee-validate/zod";
import { useStorage } from "@vueuse/core";
import { type Plate, type UrlMetaData, ItemType } from "../utils/types";

const plateValidationSchema = toTypedSchema(
  z.object({
    title: z.string({
      required_error: "Title is required!",
    }),
    author: z.string({
      required_error: "Author is required!",
    }),
    author_website: z
      .string()
      .url({ message: "That doesn't look like a URL ðŸ¤¨" })
      .or(z.string().length(0)),
  })
);

const itemValidationSchema = toTypedSchema(
  z.object({
    type: z.nativeEnum(ItemType),
    url: z.string().url(),
    description: z
      .string()
      .max(140, "Woah there. 140 max characters!")
      .optional(),
  })
);

// TODO - investigate console errors on blur of input fields,
// probably caused by these rules
// inputTypes.contains is not a function

const STORAGE_KEYS = {
  PLATE: "plate",
  ITEMS: "items",
};

const plate = useStorage(STORAGE_KEYS.PLATE, initNewPlate());
const items = useStorage<Item[]>(STORAGE_KEYS.ITEMS, []);
const item_in_progress = ref<Item | undefined>(undefined);

function initNewPlate(): Plate {
  return {
    id: 1234, // todo, remove this when we add to DB as this will be auto generated
    user_id: null,
    fingerprint: "",
    title: "",
    description: "",
    author: {
      name: "",
      website: "",
    },
  };
}

function initItem() {
  item_in_progress.value = {
    id: 4444,
    user_id: null,
    plate_id: plate.value.id,
    url: "",
    description: "",
    type: ItemType.URL,
    metaData: {
      title: "",
      description: "",
      favicon: "",
      openGraphImageUrl: "",
    },
  };
}

async function addItem() {
  console.log("adding item");

  console.log("URL IS ", item_in_progress?.value?.url);

  switch (item_in_progress?.value?.type) {
    case ItemType.URL: {
      const { data: metaData } = await useFetch(
        `/api/metadata?url=${item_in_progress?.value?.url}`
      );

      item_in_progress.value.metaData = metaData.value as UrlMetaData;

      break;
    }
    default:
      break;
  }

  items.value.push(item_in_progress.value as Item);
  item_in_progress.value = undefined;
}

function publishPlate() {
  alert("publishing plate, nothing else happens right now");
}
</script>

<template>
  <div>
    <h1 class="mb-8 font-black text-8xl">Create a plate</h1>

    <Form :validation-schema="plateValidationSchema" @submit="publishPlate">
      <div class="mb-8">
        <div class="text-right">
          <button
            class="px-4 py-2 font-mono font-bold text-white border-b-4 rounded border-emerald-700 bg-emerald-500 hover:bg-emerald-400 hover:border-emerald-500 focus:ring focus:ring-emerald-500"
            type="submit"
          >
            Publish plate
          </button>
        </div>
        <label for="title" class="block">Title</label>
        <Field
          id="title"
          v-model="plate.title"
          name="title"
          type="text"
          rules="required:Please enter a title"
          placeholder="My tasty plate"
          class="block w-full px-4 py-2 border-2 rounded focus:outline-none focus:ring focus:ring-emerald-500"
        />
        <ErrorMessage
          class="block p-2 mt-2 text-white bg-red-600 rounded"
          name="title"
        />
      </div>

      <div class="mb-8">
        <label for="author_name" class="block">Author</label>
        <Field
          id="author_name"
          v-model="plate.author.name"
          name="author"
          type="text"
          rules="required:Please enter your name"
          placeholder="Lazar Nikolov"
          class="block w-full px-4 py-2 border-2 rounded focus:outline-none focus:ring focus:ring-emerald-500"
        />
        <ErrorMessage
          class="block p-2 mt-2 text-white bg-red-600 rounded"
          name="author"
        />
      </div>

      <div class="mb-8">
        <label for="author_website" class="block"
          >Your website (optional, include https://)</label
        >
        <Field
          id="author_website"
          v-model="plate.author.website"
          name="author_website"
          type="text"
          placeholder="https://whitep4nth3r.com"
          rules="url:Please enter a valid URL including https://"
          class="block w-full px-4 py-2 border-2 rounded focus:outline-none focus:ring focus:ring-emerald-500"
        />
        <ErrorMessage
          class="block p-2 mt-2 text-white bg-red-600 rounded"
          name="author_website"
        />
      </div>

      <div v-if="items.length > 0" class="m-auto border w-96">
        <h2>Current items on plate</h2>
        <ol class="list-decimal">
          <li v-for="item in items" :key="item.id">
            <p>{{ item.description }}</p>
            <pre>{{ item.url }}</pre>
            <pre>{{ item.metaData.title }}</pre>
            <pre>{{ item.metaData.description }}</pre>
            <img :src="item.metaData.favicon as string" alt="favicon" />
            <img
              :src="item.metaData.openGraphImageUrl as string"
              :alt="item.metaData.title as string"
            />
          </li>
        </ol>
      </div>

      <div v-if="item_in_progress === undefined" class="mb-8">
        <button
          class="px-4 py-2 font-bold text-white bg-pink-500 rounded-full bg- hover:bg-pink-700 focus:ring focus:ring-emerald-500"
          @click="initItem()"
        >
          Add item
        </button>
      </div>
    </Form>

    <Form :validation-schema="itemValidationSchema" @submit="addItem">
      <div v-if="item_in_progress !== undefined" class="mb-8 border">
        <label for="item_type" class="block">Type</label>
        <select id="item_type" v-model="item_in_progress.type" name="type">
          <option
            v-for="(value, index) in Object.values(ItemType)"
            :key="index"
            :value="value"
          >
            {{ value }}
          </option>
        </select>
      </div>

      <div v-if="item_in_progress?.type === 'url'" class="mb-4">
        <h3 class="font-bold">Add a URL</h3>
        <label for="url" class="block">URL (include https://)</label>
        <Field
          id="url"
          v-model="item_in_progress.url"
          name="url"
          type="text"
          class="block w-full px-4 py-2 border-2 rounded focus:outline-none focus:ring focus:ring-emerald-500"
          rules="url:Please enter a valid URL including https://|required:Please enter a valid URL including https://"
        />
        <ErrorMessage
          class="block p-2 mt-2 text-white bg-red-600 rounded"
          name="url"
        />

        <label for="url_description" class="block">Description</label>
        <Field
          id="url_description"
          v-model="item_in_progress.description"
          name="description"
          type="text"
          class="block w-full px-4 py-2 border-2 rounded focus:outline-none focus:ring focus:ring-emerald-500"
          rules="oneForty:Please enter fewer than 140 characters"
        />
        <ErrorMessage
          class="block p-2 mt-2 text-white bg-red-600 rounded"
          name="description"
        />

        <button
          class="px-4 py-2 mt-4 font-bold text-white bg-pink-500 rounded-full bg- hover:bg-pink-700 focus:ring focus:ring-emerald-500"
          type="submit"
        >
          Add to plate
        </button>
      </div>
    </Form>
  </div>
</template>
